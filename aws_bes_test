#!/bin/sh

HYRAX="http://t41m1.opendap.org:8080/opendap"
RESULTS_DIR="./aws_bes_test.results"
echo "RESULTS_DIR: ${RESULTS_DIR}"

DAP2_CE_AIRS_ONE_VAR="ClrOLR_A[0:1:179][0:1:359]"
DAP2_CE_AIRS_ONE_VAR_AGG="ClrOLR_A[0:1:364][0:1:179][0:1:359]"
REPS=100;
AIRS_DMRPP_AGG_CHUNKS_TXT="airs_agg_clr_olr_chunks.txt"
AIRS_DMRPP_AGG_FILES="airs_dmrpp_agg_files"

# set -x 

function make_bes_cmd() {
BES_CMD=`cat <<EOF 
<?xml version="1.0" encoding="UTF-8"?>
<bes:request xmlns:bes="http://xml.opendap.org/ns/bes/1.0#" reqID="[thread:http-nio-8080-exec-9-27]">
  <bes:setContext name="xdap_accept">3.2</bes:setContext>
  <bes:setContext name="dap_explicit_containers">no</bes:setContext>
  <bes:setContext name="errors">xml</bes:setContext>
  <bes:setContext name="max_response_size">0</bes:setContext>
  <bes:setContainer name="catalogContainer" space="catalog">${DATASET}</bes:setContainer>
  <bes:define name="d1" space="default">
    <bes:container name="catalogContainer">
      <bes:constraint>${DAP2_CE}</bes:constraint>
    </bes:container>
  </bes:define>
  <bes:get type="dods" definition="d1" />
</bes:request>
EOF
`
}


function make_and_time_bess_request {
    
     make_bes_cmd
    # echo "BES_CMD: "
    # echo "${BES_CMD}"
    echo "Dataset: ${DATASET}" >> ${timing_file}
    echo "${BES_CMD}" > bes.cmd
    echo "Start: "`date -Ins` >> ${timing_file}
    { time -p besstandalone -c ${prefix}/etc/bes/bes.conf -i bes.cmd > ${response_file}; } 2>>${timing_file}
    ls -l ${response_file} >> ${timing_file}
    echo "# - - - - - - - - - - - - - - - - - -" >> ${timing_file}
    # getdap -D -M ${response_file} >> ${log_file}
    # exit;
   
}

function make_and_time_curl_range_get_request {
    
    echo "cURL: ${URL}" >> ${timing_file}
    echo "Start: "`date -Ins` >> ${timing_file}
    # echo "Start: "`date` >> ${timing_file}
    { time -p curl -s -r ${CURL_START}-${CURL_END} -g ${URL} > ${response_file}; } 2>>${timing_file}
    ls -l ${response_file} >> ${timing_file}
    echo "# - - - - - - - - - - - - - - - - - -" >> ${timing_file}   
}

function make_and_time_curl_get_request {
    
    echo "cURL: ${URL}" >> ${timing_file}
    echo "Start: "`date -Ins` >> ${timing_file}
    # echo "Start: "`date` >> ${timing_file}
    { time -p curl -s -g ${URL} > ${response_file}; } 2>>${timing_file}
    ls -l ${response_file} >> ${timing_file}
    echo "# - - - - - - - - - - - - - - - - - -" >> ${timing_file}   
}



function hyrax_airs_dataset_dmrpp_files(){
    
    log_file="${RESULTS_DIR}/hyrax_airs_dataset_dmrpp_files.log"
    response_file="${RESULTS_DIR}/hyrax_airs_dataset_dmrpp_files.dods"
    timing_file="${RESULTS_DIR}/hyrax_airs_dataset_dmrpp_files.time"

    DAP2_CE="${DAP2_CE_AIRS_ONE_VAR}"
    

    rm -f ${timing_file} ${log_file}
    for rep in {1..100}
    do
        echo "###--------------------------------------------------------" >> ${timing_file}
        echo "### hyrax_airs_dataset_dmrpp_files() - Starting REP ${rep}" >> ${timing_file}
        for DATASET in `cat ${AIRS_DMRPP_AGG_FILES}`
        do
            URL="${HYRAX}/${DATASET}.dods?${DAP2_CE}"
            make_and_time_curl_get_request
        done
    done
}

function hyrax_airs_onevar_dmrpp_agg(){
    
    log_file="${RESULTS_DIR}/hyrax_airs_dataset_dmrpp_files.log"
    response_file="${RESULTS_DIR}/hyrax_airs_dataset_dmrpp_files.dods"
    timing_file="${RESULTS_DIR}/hyrax_airs_dataset_dmrpp_files.time"

    dataset_list="t41m1/dmrpp_agg_test_06.dmrpp"
    DAP2_CE="${DAP2_CE_AIRS_ONE_VAR_AGG}"
    URL="${HYRAX}/${DATASET}.dods?${DAP2_CE}"
    

    rm -f ${timing_file} ${log_file}
    for rep in {1..1}
    do
        echo "###--------------------------------------------------------" >> ${timing_file}
        echo "### hyrax_airs_onevar_dmrpp_agg() - Starting REP ${rep}" >> ${timing_file}
        make_and_time_curl_get_request
    done
}

function bess_airs_dataset_dmrpp_files(){
    
    log_file="${RESULTS_DIR}/bess_airs_dmrpp_datasets.log"
    response_file="${RESULTS_DIR}/bess_airs_dmrpp_datasets.dods"
    timing_file="${RESULTS_DIR}/bess_airs_dmrpp_datasets.time"

    DAP2_CE="${DAP2_CE_AIRS_ONE_VAR}"


    rm -f ${timing_file} ${log_file}
    for rep in {1..100}
    do
        echo "###--------------------------------------------------------" >> ${timing_file}
        echo "### bess_airs_datset_dmrpp_files() - Starting REP ${rep}" >> ${timing_file}
        for DATASET in `cat ${AIRS_DMRPP_AGG_FILES}`
        do
            make_and_time_bess_request
        done
    done
}


function bess_airs_onevar_dmrpp_agg() {

    log_file="${RESULTS_DIR}/bess_airs_onevar_dmrpp_agg.log"
    response_file="${RESULTS_DIR}/bess_airs_onevar_dmrpp_agg.dods"
    timing_file="${RESULTS_DIR}/bess_airs_onevar_dmrpp_agg.time"

    DATASET="t41m1/dmrpp_agg_test_06.dmrpp"
    DAP2_CE="${DAP2_CE_AIRS_ONE_VAR_AGG}"
    
    rm -f ${timing_file} ${log_file}
    for rep in {1..10000}
    do
        echo "###--------------------------------------------------------" >> ${timing_file}
        echo "### bess_airs_onevar_dmrpp_agg() - Starting REP ${rep}" >> ${timing_file}
        make_and_time_bess_request
    done
}



function curl_range_get_airs_onevar_chunks(){
    
    log_file="${RESULTS_DIR}/curl_range_get_airs_onevar_chunks.log"
    response_file="${RESULTS_DIR}/curl_range_get_airs_onevar_chunks.dods"
    timing_file="${RESULTS_DIR}/curl_range_get_airs_onevar_chunks.time"

    rm -f ${timing_file} ${log_file}
    for rep in {1..10000}
    do        
        echo "### curl_range_get_airs_onevar_chunks() - Starting REP ${rep}" >> ${timing_file}
        while read chunk_row; do
            
            echo "Processing chunk: ${chunk_row}"
            URL=`echo ${chunk_row} | awk '{print $1;}' -`
            #echo "URL: ${URL}"
            OFFSET=`echo ${chunk_row} | awk '{print $2;}' -`
            #echo "OFFSET: ${OFFSET}"
            NUM_BYTES=`echo ${chunk_row} | awk '{print $3;}' -`
            echo "NUM_BYTES: ${NUM_BYTES}" >> ${timing_file}
            CHUNK_POSITION=`echo ${chunk_row} | awk '{print $4;}' -`
            #echo "CHUNK_POSITION: ${CHUNK_POSITION}"
            
            CURL_START=${OFFSET}
            CURL_END=`echo "${OFFSET} + ${NUM_BYTES} - 1" | bc`
            make_and_time_curl_range_get_request
    
        done <${AIRS_DMRPP_AGG_CHUNKS_TXT}
    done
}

rm -rf ${RESULTS_DIR}
mkdir -p ${RESULTS_DIR}

#bess_airs_dataset_dmrpp_files

#bess_airs_onevar_dmrpp_agg

#curl_range_get_airs_onevar_chunks

#hyrax_airs_dataset_dmrpp_files

hyrax_airs_onevar_dmrpp_agg
    